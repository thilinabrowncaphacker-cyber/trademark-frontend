<script>
  // Prevent back button
  window.history.pushState(null, null, window.location.href);
  window.onpopstate = () => window.history.go(1);

  // Sanitize input
  function sanitize(text) {
    return text.replace(/[<>]/g, "");
  }

  // Auth check
  if (sessionStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "index.html";
  }

  document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    window.location.href = "index.html";
  };

  // Auto logout after inactivity
  let logoutTimer;
  function resetTimer() {
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(() => {
      sessionStorage.clear();
      window.location.href = "./index.html";
    }, 10 * 60 * 1000);
  }
  document.onmousemove = resetTimer;
  document.onkeydown = resetTimer;
  resetTimer();

  // Populate class dropdown
  const classInput = document.getElementById("classInput");
  for (let i = 1; i <= 45; i++) {
    classInput.innerHTML += `<option value="${i}">${i}</option>`;
  }

  const tableBody = document.getElementById("tableBody");

  // Word-level similarity
  function wordSimilarity(input, target) {
    input = input.toLowerCase().trim();
    target = target.toLowerCase().trim();

    const inputWords = input.split(" ");
    const targetWords = target.split(" ");

    let matchCount = 0;
    inputWords.forEach(word => {
      if (targetWords.includes(word)) matchCount++;
    });

    return matchCount / inputWords.length; // 0-1
  }

  function checkClass(item, classItems) {
    let highest = 0;
    classItems.forEach(ci => {
      const sim = wordSimilarity(item, ci);
      if (sim > highest) highest = sim;
    });
    return highest;
  }

  function suggestClass(item, mgsData, currentClass) {
    let bestClass = null;
    let highestSim = 0;
    let bestItem = null;

    for (const key in mgsData) {
      if (key === currentClass) continue;
      const classItems = mgsData[key].items;
      classItems.forEach(ci => {
        const sim = wordSimilarity(item, ci);
        if (sim > highestSim) {
          highestSim = sim;
          bestClass = mgsData[key].class_name;
          bestItem = ci;
        }
      });
    }

    return { suggestedClass: bestClass || "No suitable class found", score: Math.round(highestSim*100), item: bestItem };
  }

  document.getElementById("trademarkForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const classNo = classInput.value;
    const goods = sanitize(document.getElementById("goodsInput").value);
    const goodsList = goods.split(/,|;|\n/).map(g => g.trim()).filter(Boolean);

    tableBody.innerHTML = "<tr><td colspan='3'>Checking...</td></tr>";
    document.getElementById("suggestionsCard").style.display = "none";

    const res = await fetch("https://trademark-backend-production.up.railway.app/check", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ classNo, goods: goodsList })
    });

    const data = await res.json();
    tableBody.innerHTML = "";

    data.forEach(r => {
      const color = r.score >= 80 ? '#4caf50' : r.score >= 50 ? '#ffb300' : '#f44336';
      const progressSVG = `
        <svg viewBox="0 0 36 36" class="circular-chart">
          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="circle" stroke="${color}" stroke-dasharray="${r.score},100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <text x="18" y="20.35" class="percentage">${r.score}%</text>
        </svg>
      `;

      tableBody.innerHTML += `
        <tr>
          <td class="text-xs font-weight-bold">${r.good}</td>
          <td class="text-center">${progressSVG}</td>
          <td class="text-xs">
            ${r.score >= 90
              ? "✅ Acceptable as per Nice Classification"
              : r.score >= 50
                ? `⚠️ Partially matches. Suggested: Class ${r.suggestions[0]?.class} — ${r.suggestions[0]?.item} (${r.suggestions[0]?.score}%)`
                : `❌ Does not fit. Closest match: Class ${r.suggestions[0]?.class} — ${r.suggestions[0]?.item} (${r.suggestions[0]?.score}%)`
            }
          </td>
        </tr>
      `;

      // Show suggestions if any
              const suggestionsList = document.getElementById("suggestionsList");
        if (!r.matched && r.suggestions.length > 0) {
          suggestionsList.innerHTML = "";
          r.suggestions.forEach(s => {
            suggestionsList.innerHTML += `<li class="list-group-item">Class ${s.class} — ${s.item} (${s.score}%)</li>`;
          });
          document.getElementById("suggestionsCard").style.display = "block";
        } else if (r.matched) {
          document.getElementById("suggestionsCard").style.display = "none";
        }

    });
  });

  document.getElementById("resetBtn").onclick = () => {
    document.getElementById("goodsInput").value = "";
    tableBody.innerHTML = "";
    classInput.value = "";
    document.getElementById("suggestionsCard").style.display = "none";
  };
</script>
